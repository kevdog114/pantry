<form *ngIf="recipe">
    <mat-tab-group>
        <mat-tab label="Details">
            <div class="row">
                <mat-form-field>
                    <mat-label>Recipe Title</mat-label>
                    <input name="title" matInput [(ngModel)]="recipe.title" />
                </mat-form-field>
            </div>
            <div class="row">
                <mat-form-field>
                    <mat-label>Description</mat-label>
                    <textarea name="description" matInput [(ngModel)]="recipe.description"></textarea>
                </mat-form-field>
            </div>
            <div class="row">
                <mat-form-field>
                    <mat-label>Source</mat-label>
                    <input name="source" matInput [(ngModel)]="recipe.source" />
                </mat-form-field>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <mat-form-field class="w-100">
                        <mat-label>Prep Time</mat-label>
                        <input name="prepTime" matInput [(ngModel)]="recipe.prepTime">
                    </mat-form-field>
                </div>
                <div class="col-sm-4">
                    <mat-form-field class="w-100">
                        <mat-label>Cook Time</mat-label>
                        <input name="cookTime" matInput [(ngModel)]="recipe.cookTime">
                    </mat-form-field>
                </div>
                <div class="col-sm-4">
                    <mat-form-field class="w-100">
                        <mat-label>Total Time</mat-label>
                        <input name="totalTime" matInput [(ngModel)]="recipe.totalTime">
                    </mat-form-field>
                </div>
                <div class="col-sm-4">
                    <mat-form-field class="w-100">
                        <mat-label>Yield</mat-label>
                        <input name="yield" matInput [(ngModel)]="recipe.yield">
                    </mat-form-field>
                </div>
            </div>
        </mat-tab>
        <mat-tab label="Ingredients">
            <div class="row mt-3 mb-2">
                <div class="col-12">
                    <button mat-raised-button color="accent" type="button" (click)="addIngredient()">
                        <mat-icon>add</mat-icon> Add Ingredient
                    </button>
                    <span class="ms-3 text-muted" *ngIf="recipe.ingredients?.length === 0">No ingredients added
                        yet.</span>
                </div>
            </div>

            <div *ngFor="let ing of recipe.ingredients; let i = index; trackBy: trackByFn"
                class="row align-items-center mb-2">
                <div class="col-md-5 col-12">
                    <mat-form-field class="w-100">
                        <mat-label>Ingredient Name / Product</mat-label>
                        <input type="text" matInput [(ngModel)]="ing.name" [name]="'ing-name-' + i"
                            [matAutocomplete]="auto">
                        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onProductSelected(ing, $event)">
                            <mat-option *ngFor="let prod of getFilteredProducts(ing.name)" [value]="prod">
                                {{prod.title}}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                </div>
                <div class="col-md-3 col-6">
                    <mat-form-field class="w-100">
                        <mat-label>Amount</mat-label>
                        <input type="number" matInput [(ngModel)]="ing.amount" [name]="'ing-amount-' + i">
                    </mat-form-field>
                </div>
                <div class="col-md-3 col-6">
                    <mat-form-field class="w-100">
                        <mat-label>Unit</mat-label>
                        <input type="text" matInput [(ngModel)]="ing.unit" [name]="'ing-unit-' + i">
                    </mat-form-field>
                </div>
                <div class="col-md-1 col-12 text-end text-md-start">
                    <button mat-icon-button color="warn" (click)="removeIngredient(i)"
                        type="button"><mat-icon>delete</mat-icon></button>
                </div>
            </div>
        </mat-tab>
        <mat-tab label="Prep & Thaw">
            <div class="row mt-3 mb-2">
                <div class="col-12 d-flex gap-2">
                    <button mat-raised-button color="primary" type="button" (click)="addPrepTask()">
                        <mat-icon>add</mat-icon> Add Prep Task
                    </button>
                    <button mat-stroked-button color="accent" type="button" (click)="generateThawAdvice()"
                        [disabled]="!recipe.ingredients || recipe.ingredients.length === 0">
                        <mat-icon>auto_awesome</mat-icon> Generate Thaw Tasks
                    </button>
                </div>
                <div class="col-12 mt-2">
                    <span class="text-muted" *ngIf="recipe.prepTasks?.length === 0">No prep tasks added.</span>
                </div>
            </div>

            <div *ngFor="let task of recipe.prepTasks; let i = index; trackBy: trackByFn"
                class="row align-items-center mb-2">
                <div class="col-md-7 col-12">
                    <mat-form-field class="w-100">
                        <mat-label>Task Description</mat-label>
                        <input matInput [(ngModel)]="task.description" [name]="'task-desc-' + i"
                            placeholder="e.g. Marinate Chicken">
                    </mat-form-field>
                </div>
                <div class="col-md-3 col-6">
                    <mat-form-field class="w-100">
                        <mat-label>Days Ahead</mat-label>
                        <input type="number" matInput [(ngModel)]="task.daysInAdvance" [name]="'task-days-' + i"
                            min="0">
                        <span matSuffix class="ms-1 small">days</span>
                    </mat-form-field>
                </div>
                <div class="col-md-2 col-6 text-end">
                    <button mat-icon-button color="warn" (click)="removePrepTask(i)"
                        type="button"><mat-icon>delete</mat-icon></button>
                </div>
            </div>

        </mat-tab>
        <mat-tab label="Steps">
            <button mat-icon-button (click)="addStep()"><mat-icon>add</mat-icon></button>
            <div *ngFor="let step of recipe.steps; let i = index; trackBy: trackByFn">
                <mat-form-field class="w-100">
                    <mat-label>Step {{i + 1}}</mat-label>
                    <textarea matInput [(ngModel)]="step.description" [name]="'step-' + i" rows="3"></textarea>
                </mat-form-field>
                <button mat-icon-button (click)="removeStep(i)"><mat-icon>delete</mat-icon></button>
                <button mat-icon-button (click)="moveStepUp(i)"
                    [disabled]="i === 0"><mat-icon>arrow_upward</mat-icon></button>
                <button mat-icon-button (click)="moveStepDown(i)"
                    [disabled]="i === recipe.steps.length - 1"><mat-icon>arrow_downward</mat-icon></button>
            </div>
        </mat-tab>
        <mat-tab label="Kiosk Actions">
            <ng-template matTabContent>
                <div class="row mt-3 mb-2">
                    <div class="col-12 d-flex gap-2">
                        <button mat-raised-button color="primary" type="button" (click)="addQuickAction()">
                            <mat-icon>add</mat-icon> Add Action
                        </button>
                        <button mat-stroked-button color="accent" type="button" (click)="generateQuickActions()">
                            <mat-icon>auto_awesome</mat-icon> Auto-Detect Actions
                        </button>
                    </div>
                </div>

                <div *ngFor="let action of recipe.quickActions; let i = index; trackBy: trackByFn"
                    class="row align-items-center mb-2">
                    <div class="col-md-5 col-12">
                        <mat-form-field class="w-100">
                            <mat-label>Action Name</mat-label>
                            <input matInput [(ngModel)]="action.name" [name]="'qa-name-' + i"
                                placeholder="e.g. Cook Chicken">
                        </mat-form-field>
                    </div>
                    <div class="col-md-3 col-6">
                        <mat-form-field class="w-100">
                            <mat-label>Type</mat-label>
                            <mat-select [(ngModel)]="action.type" [name]="'qa-type-' + i">
                                <mat-option [value]="'timer'">Timer</mat-option>
                                <mat-option [value]="'weigh'">Weigh</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    <div class="col-md-3 col-6">
                        <mat-form-field class="w-100">
                            <mat-label>{{ action.type === 'weigh' ? 'Weight (Grams)' : 'Duration (Minutes)'
                                }}</mat-label>
                            <input matInput [(ngModel)]="action.value" [name]="'qa-value-' + i"
                                [placeholder]="action.type === 'weigh' ? 'e.g. 200' : 'e.g. 10-12'">
                        </mat-form-field>
                    </div>
                    <div class="col-md-1 col-12 text-end">
                        <button mat-icon-button color="warn" (click)="removeQuickAction(i)"
                            type="button"><mat-icon>delete</mat-icon></button>
                    </div>
                </div>
            </ng-template>
        </mat-tab>
        <mat-tab label="Images">
            <div class="row align-items-center mt-3">
                <div class="col-12 d-flex gap-2 mb-3">
                    <button mat-raised-button color="accent" (click)="generateImage()"
                        [disabled]="isGeneratingImage || !recipe.title">
                        <mat-icon>{{ isGeneratingImage ? 'hourglass_empty' : 'auto_awesome' }}</mat-icon>
                        {{ isGeneratingImage ? 'Generating Image...' : 'Generate AI Image' }}
                    </button>
                    <!-- Upload Input -->
                    <button mat-stroked-button color="primary" (click)="fileInput.click()">
                        <mat-icon>upload</mat-icon> Upload Image
                    </button>
                    <input #fileInput type="file" multiple (change)="browsedFiles($event)" [(ngModel)]="inputValue"
                        [ngModelOptions]="{standalone: true}" style="display: none;" />
                </div>
            </div>

            <div class="row">
                <div class="col-6 col-md-4 col-lg-3 mb-3" *ngFor="let file of recipe.files">
                    <mat-card class="h-100">
                        <img mat-card-image [src]="GetFileDownloadUrl(file)" alt="Recipe Image"
                            style="height: 200px; object-fit: cover;">
                        <mat-card-actions align="end">
                            <button mat-button color="warn" (click)="removeImage(file)">Remove</button>
                        </mat-card-actions>
                    </mat-card>
                </div>
                <div class="col-12" *ngIf="!recipe.files || recipe.files.length === 0">
                    <p class="text-muted">No images added yet.</p>
                </div>
            </div>
        </mat-tab>
    </mat-tab-group>

    <button mat-raised-button (click)="save()">Save</button>
    <button mat-raised-button (click)="delete()">Delete</button>
</form>