<div class="kiosk-container">
    <!-- Status Section (Collapsible Header) -->
    <div class="status-section" [class.minimized]="isFullScreen(viewState)">
        <mat-icon *ngIf="activeMode !== 'NONE'" class="pulse-icon">qr_code_scanner</mat-icon>

        <div class="d-flex flex-column align-items-center" [class.align-items-start]="isFullScreen(viewState)">
            <h1 class="status-text">{{ status }}</h1>
            <h2 *ngIf="statusSubtext" class="status-subtext">{{ statusSubtext }}</h2>
        </div>

        <!-- Mini Timer Widget (Only on Main Screen) -->
        <div *ngIf="viewState === 'MAIN' && activeMode === 'NONE' && activeTimers.length > 0"
            class="absolute top-8 right-8 flex flex-col gap-2 pointer-events-none">
            <div *ngFor="let timer of activeTimers"
                class="bg-black/50 backdrop-blur border border-white/10 rounded-lg p-3 flex items-center gap-4">
                <mat-icon class="text-orange-500 animate-pulse">timer</mat-icon>
                <span class="font-mono text-xl font-bold">{{ formatTimer(timer.remainingSeconds) }}</span>
            </div>
        </div>
    </div>

    <!-- Main Action Area -->
    <div class="action-section">

        <!-- --- MODES (Restock, Consume, Inventory) --- -->

        <!-- RESTOCK -->
        <div *ngIf="activeMode === 'RESTOCK'" class="h-full flex items-center justify-center">
            <button class="k-btn success h-[300px] w-[300px] rounded-full" (click)="finishAction()">
                <mat-icon style="font-size: 80px; width: 80px; height: 80px;">check_circle</mat-icon>
                <span>FINISH RESTOCK</span>
            </button>
        </div>

        <!-- CONSUME -->
        <div *ngIf="activeMode === 'CONSUME'" class="h-full flex items-center justify-center">
            <button class="k-btn primary h-[300px] w-[300px] rounded-full bg-cyan-900" (click)="finishAction()">
                <mat-icon style="font-size: 80px; width: 80px; height: 80px;">check_circle</mat-icon>
                <span>FINISH CONSUME</span>
            </button>
        </div>

        <!-- INVENTORY -->
        <div *ngIf="activeMode === 'INVENTORY'" class="h-full flex items-center justify-center">
            <button class="k-btn h-[120px] w-[300px]" (click)="finishAction()">
                <mat-icon>arrow_back</mat-icon>
                <span>BACK</span>
            </button>
        </div>

        <!-- --- VIEW STATES --- -->

        <!-- MAIN MENU -->
        <div *ngIf="viewState === 'MAIN' && activeMode === 'NONE'" class="grid-menu compact">
            <button class="k-btn primary" (click)="setMode('RESTOCK')">
                <mat-icon>inventory_2</mat-icon><span>RESTOCK</span>
            </button>
            <button class="k-btn primary" (click)="setMode('CONSUME')">
                <mat-icon>restaurant</mat-icon><span>CONSUME</span>
            </button>

            <button class="k-btn accent" (click)="openCook()">
                <mat-icon>menu_book</mat-icon><span>COOK</span>
            </button>
            <button class="k-btn" (click)="setMode('INVENTORY')">
                <mat-icon>inventory</mat-icon><span>INVENTORY</span>
            </button>

            <!-- Bottom Row -->
            <button class="k-btn" (click)="openUtilities()">
                <mat-icon>build</mat-icon><span>UTILITIES</span>
            </button>
            <button class="k-btn" style="border-color: var(--k-accent);" (click)="openTimers()">
                <mat-icon class="text-orange-500">timer</mat-icon><span>TIMERS</span>
            </button>
        </div>

        <!-- UTILITIES -->
        <div *ngIf="viewState === 'UTILITIES'" class="grid-menu">
            <!-- Header/Back -->
            <div class="col-span-2 back-btn-row">
                <button class="k-icon-btn" (click)="closeUtilities()"><mat-icon>arrow_back</mat-icon></button>
                <span class="text-xl ml-4 font-bold text-gray-400">UTILITIES</span>
            </div>

            <button class="k-btn primary" (click)="openPrintLabels()">
                <mat-icon>print</mat-icon><span>PRESETS</span>
            </button>
            <button class="k-btn accent" (click)="openQuickLabel()">
                <mat-icon>edit_note</mat-icon><span>QUICK LABEL</span>
            </button>
            <button class="k-btn" (click)="scaleAction()">
                <mat-icon>scale</mat-icon><span>SCALE</span>
            </button>
            <button class="k-btn" (click)="printShoppingList()">
                <mat-icon>list_alt</mat-icon><span>PRINT LIST</span>
            </button>
            <button *ngIf="pbxConfig && pbxConfig.enabled" class="k-btn success col-span-2" (click)="openPhone()">
                <mat-icon>phone</mat-icon><span>PHONE</span>
            </button>
        </div>

        <!-- PRINT LABELS -->
        <div *ngIf="viewState === 'PRINT_LABELS'" class="grid-menu">
            <div class="col-span-2 back-btn-row">
                <button class="k-icon-btn" (click)="openUtilities()"><mat-icon>arrow_back</mat-icon></button>
                <span class="text-xl ml-4 font-bold text-gray-400">PRINT PRESETS</span>
            </div>

            <button class="k-btn primary" (click)="printLabel('Opened', 0)">
                <mat-icon>calendar_today</mat-icon><span>OPENED TODAY</span>
            </button>
            <button class="k-btn warn" (click)="printLabel('Expires', 3)">
                <mat-icon>timer</mat-icon><span>EXP +3 DAYS</span>
            </button>
            <button class="k-btn warn" (click)="printLabel('Expires', 7)">
                <mat-icon>timer</mat-icon><span>EXP +7 DAYS</span>
            </button>
            <button class="k-btn warn" (click)="printLabel('Expires', 30)">
                <mat-icon>timer</mat-icon><span>EXP +1 MONTH</span>
            </button>
        </div>

        <!-- QUICK LABEL -->
        <div *ngIf="viewState === 'QUICK_LABEL'" class="quick-label-layout">
            <div class="back-btn-row">
                <button class="k-icon-btn" (click)="openUtilities()"><mat-icon>arrow_back</mat-icon></button>
            </div>

            <div class="ql-type-grid">
                <button *ngFor="let type of quickLabelTypes" class="k-btn"
                    [class.primary]="quickLabelSelectedType === type" (click)="selectQuickLabelType(type)">
                    <mat-icon>{{ getQuickLabelIcon(type) }}</mat-icon>
                    <span>{{ type }}</span>
                </button>
            </div>

            <div class="flex-1 flex gap-4">
                <!-- Date Picker styled container -->
                <div
                    class="flex-1 bg-white/5 border border-white/10 rounded-2xl flex flex-col items-center justify-center p-6 relative">
                    <span class="text-gray-400 font-bold mb-4">DATE</span>
                    <!-- Hidden input hack or custom UI? keeping Angular Material picker for functionality but styling wrapper -->
                    <mat-form-field appearance="fill" class="w-full text-center">
                        <mat-label>Choose Date</mat-label>
                        <input matInput [matDatepicker]="picker" [(ngModel)]="quickLabelDate">
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker touchUi></mat-datepicker>
                    </mat-form-field>
                    <div class="text-2xl mt-4 font-mono text-cyan-400">{{ quickLabelDate | date:'fullDate' }}</div>
                </div>

                <button class="k-btn accent w-1/3" (click)="printCustomQuickLabel()"
                    [disabled]="!quickLabelSelectedType || !quickLabelDate">
                    <mat-icon style="font-size: 64px; width: 64px; height: 64px;">print</mat-icon>
                    <span>PRINT</span>
                </button>
            </div>
        </div>

        <!-- SCALE (Full Screen Overlay) -->
        <!-- SCALE (Full Screen Overlay) - Redesigned for 6-inch screen without Tailwind -->
        <div *ngIf="viewState === 'SCALE'" class="scale-view-overlay">
            <!-- Header -->
            <div class="scale-header">
                <button class="k-icon-btn" (click)="closeScale()">
                    <mat-icon>arrow_back</mat-icon>
                </button>
                <div class="scale-header-title">SCALE</div>

                <!-- Target Indicator -->
                <div *ngIf="targetWeight" class="scale-target-badge">
                    <span class="scale-target-label">TARGET</span>
                    <span class="scale-target-value">{{ targetWeight }}</span>
                    <span class="scale-target-unit">{{ currentUnit }}</span>
                </div>
            </div>

            <!-- Main Weight Display -->
            <div class="scale-content">
                <!-- Progress Background Bar -->
                <div *ngIf="targetWeight" class="scale-progress-bar-container">
                    <div class="scale-progress-fill" [style.width.%]="progressValue"></div>
                </div>

                <!-- Weight Value -->
                <div class="d-flex align-items-baseline justify-content-center w-100 position-relative"
                    style="z-index: 2;">
                    <span class="scale-weight-text">{{ displayWeight | number:'1.0-1' }}</span>
                    <span class="scale-unit-text">{{ currentUnit }}</span>
                </div>

                <!-- Visual Guide for Target -->
                <div *ngIf="targetWeight" class="scale-percentage-text" [class.text-red-500]="progressValue > 105"
                    [class.text-green-400]="progressValue >= 95 && progressValue <= 105"
                    [class.text-blue-400]="progressValue < 95">
                    {{ progressValue.toFixed(0) }}%
                </div>
            </div>

            <!-- Controls -->
            <div class="scale-controls-area">
                <button class="btn-scale-action btn-scale-tare" (click)="tareScale()">
                    <mat-icon>restart_alt</mat-icon>
                    <span>TARE</span>
                </button>
                <button class="btn-scale-action btn-scale-unit" (click)="toggleUnit()">
                    <mat-icon>swap_vert</mat-icon>
                    <span>UNIT</span>
                </button>
            </div>
        </div>

        <!-- TIMERS -->
        <div *ngIf="viewState === 'TIMERS'" class="timers-layout">
            <div class="back-btn-row">
                <button class="k-icon-btn" (click)="closeTimers()"><mat-icon>arrow_back</mat-icon></button>
            </div>

            <!-- View Content -->
            <div class="flex-1 overflow-y-auto px-2">

                <!-- Recipe Timers Section -->
                <ng-container *ngIf="selectedRecipe && recipeTimerActions.length > 0">
                    <div class="text-gray-400 font-bold mb-2 fs-lg border-b border-gray-700 pb-1">RECIPE TIMERS</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px;"
                        class="mb-6">
                        <button *ngFor="let action of recipeTimerActions" class="k-btn accent"
                            style="min-height: 180px; border-color: orange; color: orange;"
                            (click)="startQuickAction(action)">
                            <div class="d-flex flex-column align-items-center" style="line-height:1.2">
                                <span class="fs-xs text-uppercase opacity-80 mb-1">{{ action.name }}</span>

                                <ng-container *ngIf="getTimerForAction(action) as activeT; else staticContent">
                                    <span class="fs-2xl fw-bold text-k-warn pulse-text"
                                        style="font-family: monospace;">{{ formatTimer(activeT.remainingSeconds)
                                        }}</span>
                                    <span class="fs-xs fw-bold text-k-warn">RUNNING</span>
                                </ng-container>
                                <ng-template #staticContent>
                                    <span class="fs-2xl fw-bold">{{ action.value }}</span>
                                </ng-template>
                            </div>
                        </button>
                    </div>
                </ng-container>

                <!-- Custom Timers Section -->
                <div class="text-gray-400 font-bold mb-2 fs-lg border-b border-gray-700 pb-1">CUSTOM TIMERS</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;"
                    class="mb-6">
                    <button *ngFor="let m of [5, 10, 15, 20, 30, 45, 60, 90]" class="timer-preset"
                        style="min-height: 100px;" (click)="createTimer(m)">
                        {{m}}m
                    </button>
                </div>

                <!-- Active Timers Section -->
                <div class="text-k-primary font-bold mb-2 fs-lg border-b border-k-primary pb-1"
                    *ngIf="activeTimers.length > 0">ACTIVE</div>
            </div>

            <div class="active-timers-list">
                <div *ngIf="activeTimers.length === 0" class="text-center text-gray-500 mt-10 text-2xl">
                    NO ACTIVE TIMERS
                </div>

                <div *ngFor="let timer of activeTimers" class="timer-card">
                    <div>
                        <div class="timer-label">{{ timer.name || 'Timer' }}</div>
                        <div class="timer-time">{{ formatTimer(timer.remainingSeconds) }}</div>
                    </div>
                    <button class="k-icon-btn" style="border-color: var(--k-warn); color: var(--k-warn);"
                        (click)="deleteTimer(timer.id)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </div>
            </div>
        </div>

        <!-- PHONE -->
        <div *ngIf="viewState === 'PHONE'" class="phone-layout">
            <div class="back-btn-row w-full">
                <button class="k-icon-btn" (click)="closePhone()"><mat-icon>close</mat-icon></button>
            </div>

            <div class="phone-display">
                <span class="phone-number">{{ dialNumber || '...' }}</span>
                <button class="k-icon-btn" style="border:none"
                    (click)="clearDigit()"><mat-icon>backspace</mat-icon></button>
            </div>

            <!-- Quick Dials Ribbon -->
            <div class="flex gap-4 overflow-x-auto pb-2" *ngIf="pbxConfig?.extensions?.length">
                <button *ngFor="let ext of pbxConfig!.extensions"
                    class="h-12 px-4 rounded-full border border-white/20 bg-white/5 whitespace-nowrap"
                    (click)="dial(ext.number)">
                    {{ ext.name }}
                </button>
            </div>

            <div class="dial-pad">
                <button *ngFor="let d of ['1','2','3','4','5','6','7','8','9','*','0','#']" class="dial-btn"
                    (click)="appendDigit(d)">{{d}}</button>
            </div>

            <button class="call-btn" (click)="dial(dialNumber)">
                <mat-icon style="font-size: 40px; width: 40px; height: 40px;">call</mat-icon>
            </button>
        </div>

        <!-- COOK -->
        <div *ngIf="viewState === 'COOK'" class="cook-layout">
            <div class="d-flex align-items-center justify-content-between">
                <button class="k-btn warn w-auto px-6 h-12 flex-row" (click)="closeCook()">
                    <mat-icon>arrow_back</mat-icon><span class="text-sm">EXIT COOK MODE</span>
                </button>
                <h2 class="fs-2xl fw-bold truncate ml-4" *ngIf="selectedRecipe">{{ selectedRecipe.title }}</h2>
            </div>

            <!-- Selection Mode -->
            <div *ngIf="!selectedRecipe && availableInstructions.length === 0"
                class="flex flex-col flex-1 gap-4 overflow-hidden mt-4">

                <!-- Scan Prompt (Compact Bar) -->
                <div
                    class="h-24 shrink-0 rounded-2xl border-2 border-dashed border-white/20 bg-white/5 d-flex align-items-center justify-content-center gap-4">
                    <mat-icon class="text-4xl text-k-primary animate-pulse">qr_code_scanner</mat-icon>
                    <h3 class="fs-2xl fw-light text-k-dim">SCAN RECIPE OR PRODUCT</h3>
                </div>

                <!-- Upcoming Meals -->
                <div class="cook-column flex-1">
                    <div class="cook-header">UPCOMING MEALS</div>
                    <div class="flex-1 overflow-y-auto">
                        <button *ngFor="let meal of upcomingMeals" class="meal-item"
                            (click)="selectInstruction(meal.recipe)">
                            <div>
                                <div class="fs-xs text-k-accent fw-bold mb-1">{{ getMealDateLabel(meal.date) |
                                    uppercase }}</div>
                                <div class="fs-lg fw-bold">{{ meal.recipe.title }}</div>
                            </div>
                            <mat-icon>chevron_right</mat-icon>
                        </button>
                        <div *ngIf="upcomingMeals.length === 0" class="p-8 text-center text-gray-500">No planned meals
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instruction Multi-Select -->
            <div *ngIf="!selectedRecipe && availableInstructions.length > 0" class="flex-1 overflow-y-auto">
                <h2 class="fs-2xl fw-bold mb-4 text-center">Select Version</h2>
                <div class="instruction-grid">
                    <button *ngFor="let instruction of availableInstructions" class="k-btn primary h-40"
                        (click)="selectInstruction(instruction)">
                        <mat-icon>menu_book</mat-icon>
                        <span class="text-sm text-center">{{ (instruction.name || instruction.title) }}</span>
                    </button>
                </div>
            </div>

            <!-- ACTIVE RECIPE -->
            <div *ngIf="selectedRecipe" class="recipe-active-view">

                <!-- MAIN COOK MENU (3 Big Buttons) -->
                <div *ngIf="!showScaleOptions" class="recipe-content w-100"
                    style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; align-content: center; height: 100%;">

                    <button class="k-btn accent" (click)="openTimers()">
                        <mat-icon style="font-size: 80px; width: 80px; height: 80px;">timer</mat-icon>
                        <span class="fs-2xl mt-4">TIMERS</span>
                    </button>

                    <button class="k-btn" (click)="scaleAction()">
                        <mat-icon style="font-size: 80px; width: 80px; height: 80px;">scale</mat-icon>
                        <span class="fs-2xl mt-4">WEIGH</span>
                    </button>

                    <button class="k-btn" (click)="printRecipeReceipt()">
                        <mat-icon style="font-size: 80px; width: 80px; height: 80px;">receipt_long</mat-icon>
                        <span class="fs-2xl mt-4">PRINT</span>
                    </button>

                </div>

                <!-- CALL OUT: SCALE SUB-MENU -->
                <div *ngIf="showScaleOptions" class="recipe-content w-100 d-flex flex-column">
                    <div class="d-flex align-items-center mb-4 border-bottom border-secondary pb-3">
                        <button class="k-icon-btn me-4" (click)="showScaleOptions = false">
                            <mat-icon>arrow_back</mat-icon>
                        </button>
                        <span class="fs-2xl fw-bold text-k-primary">WEIGH OPTIONS</span>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px;">

                        <!-- Recipe Specific Weighs -->
                        <button *ngFor="let action of recipeScaleActions" class="k-btn" [class.warn]="true"
                            style="min-height: 200px;" (click)="startQuickAction(action)">
                            <mat-icon>scale</mat-icon>
                            <span class="fs-lg mt-2">{{ action.name }}</span>
                            <span class="fs-2xl fw-bold">{{ action.value }}</span>
                        </button>

                        <!-- Free Scale -->
                        <button class="k-btn primary" style="min-height: 200px;" (click)="openFreeScale()">
                            <mat-icon>open_in_full</mat-icon>
                            <span class="fs-2xl mt-2">FREE WEIGH</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- Floating Timers in Cook Mode -->
            <div *ngIf="activeTimers.length > 0" class="h-20 flex gap-4 overflow-x-auto pb-2">
                <div *ngFor="let timer of activeTimers"
                    class="bg-gray-800 border-l-4 border-orange-500 rounded p-2 flex items-center min-w-[180px] justify-between">
                    <div>
                        <div class="text-xs text-gray-400">{{ timer.name }}</div>
                        <div class="font-mono text-xl">{{ formatTimer(timer.remainingSeconds) }}</div>
                    </div>
                    <button class="k-icon-btn h-8 w-8" (click)="removeTimer(timer)"><mat-icon
                            class="text-sm">close</mat-icon></button>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="footer">
            <span class="font-bold tracking-widest uppercase">{{ pantryName }}</span>

            <span class="connection-status" [class.offline]="!isOnline">
                <mat-icon *ngIf="scannerClaimedBy === 'Me'"
                    class="align-bottom text-red-500 mr-2">qr_code_scanner</mat-icon>
                {{ isOnline ? 'ONLINE' : 'OFFLINE' }}
            </span>

            <span class="font-mono text-gray-500">{{ currentDate | date:'shortTime' }}</span>
            <button mat-button class="ml-4 opacity-50 hover:opacity-100" (click)="exitKiosk()">EXIT</button>
        </div>
    </div>

    <!-- CALL OVERLAY (Keep mostly same but style) -->
    <div *ngIf="incomingCall || (callState && callState.state !== 'DISCONNECTED')"
        class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
        style="z-index: 10000; background: rgba(0,0,0,0.9);">
        <div
            class="bg-gray-900 border border-white/20 rounded-3xl p-10 flex flex-col items-center gap-8 shadow-2xl animate-pulse">
            <div class="h-32 w-32 rounded-full bg-green-500/20 flex items-center justify-center animate-bounce">
                <mat-icon class="text-6xl text-green-500 scale-[2]">phone_in_talk</mat-icon>
            </div>
            <div class="text-center">
                <h2 class="text-4xl font-bold text-white mb-2">{{ incomingCall ? 'INCOMING CALL' : 'IN CALL' }}</h2>
                <p class="text-2xl text-cyan-400">{{ incomingCall?.remote_uri || callState?.state }}</p>
            </div>

            <div class="flex gap-8">
                <button *ngIf="incomingCall" class="call-btn bg-green-500 scale-125" (click)="answerCall()">
                    <mat-icon>call</mat-icon>
                </button>
                <button class="call-btn bg-red-600 scale-125" (click)="hangupCall()">
                    <mat-icon>call_end</mat-icon>
                </button>
            </div>
        </div>
    </div>