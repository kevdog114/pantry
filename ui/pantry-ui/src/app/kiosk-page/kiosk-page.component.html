<div class="kiosk-container">
    <!-- Status Section (Top 50%) -->
    <div class="status-section" [class.scanning]="activeMode !== 'NONE'">
        <h1 class="status-text">{{ status }}</h1>
        <h2 *ngIf="statusSubtext" class="status-subtext">{{ statusSubtext }}</h2>
        <mat-icon *ngIf="activeMode !== 'NONE'" class="pulse-icon">qr_code_scanner</mat-icon>
    </div>

    <!-- Action Section (Bottom 50%) -->
    <div class="action-section">

        <!-- RESTOCK VIEW -->
        <div *ngIf="activeMode === 'RESTOCK'" class="button-grid single-action-grid">
            <button mat-flat-button class="large-btn finish-btn" (click)="finishAction()">
                <div class="btn-content">
                    <mat-icon>check_circle</mat-icon>
                    <span>FINISH RESTOCKING</span>
                </div>
            </button>
        </div>

        <!-- CONSUME VIEW -->
        <div *ngIf="activeMode === 'CONSUME'" class="button-grid single-action-grid">
            <button mat-flat-button class="large-btn finish-btn consume-finish" (click)="finishAction()">
                <div class="btn-content">
                    <mat-icon>check_circle</mat-icon>
                    <span>FINISH CONSUMING</span>
                </div>
            </button>
        </div>

        <!-- INVENTORY VIEW -->
        <div *ngIf="activeMode === 'INVENTORY'" class="button-grid single-action-grid">
            <button mat-stroked-button class="large-btn back-btn" (click)="finishAction()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>BACK</span>
                </div>
            </button>
        </div>

        <!-- MAIN VIEW -->
        <div *ngIf="viewState === 'MAIN' && activeMode === 'NONE'" class="button-grid compact-grid">
            <button mat-flat-button color="primary" class="large-btn" (click)="setMode('RESTOCK')">
                <div class="btn-content">
                    <mat-icon>inventory_2</mat-icon>
                    <span>RESTOCK</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="setMode('CONSUME')">
                <div class="btn-content">
                    <mat-icon>restaurant</mat-icon>
                    <span>CONSUME</span>
                </div>
            </button>

            <button mat-flat-button color="accent" class="large-btn" (click)="goToMealPlan()">
                <div class="btn-content">
                    <mat-icon>menu_book</mat-icon>
                    <span>COOK</span>
                </div>
            </button>

            <button mat-flat-button color="accent" class="large-btn inventory-btn" (click)="setMode('INVENTORY')">
                <div class="btn-content">
                    <mat-icon>inventory</mat-icon>
                    <span>INVENTORY</span>
                </div>
            </button>

            <button mat-flat-button class="large-btn utility-btn" (click)="openUtilities()">
                <div class="btn-content">
                    <mat-icon>build</mat-icon>
                    <span>UTILITIES</span>
                </div>
            </button>

            <button *ngIf="pbxConfig && pbxConfig.enabled" mat-flat-button class="large-btn phone-btn"
                (click)="openPhone()" style="background-color: #4CAF50; color: white;">
                <div class="btn-content">
                    <mat-icon>phone</mat-icon>
                    <span>PHONE</span>
                </div>
            </button>
        </div>

        <!-- UTILITIES VIEW -->
        <div *ngIf="viewState === 'UTILITIES'" class="button-grid">
            <button mat-stroked-button class="large-btn back-btn" (click)="closeUtilities()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>MAIN MENU</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="openPrintLabels()">
                <div class="btn-content">
                    <mat-icon>print</mat-icon>
                    <span>PRINT LABELS</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="scaleAction()">
                <div class="btn-content">
                    <mat-icon>scale</mat-icon>
                    <span>SCALE</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="printShoppingList()">
                <div class="btn-content">
                    <mat-icon>list_alt</mat-icon>
                    <span>PRINT LIST</span>
                </div>
            </button>
        </div>

        <!-- PRINT LABELS VIEW -->
        <div *ngIf="viewState === 'PRINT_LABELS'" class="button-grid compact-grid">
            <button mat-stroked-button class="large-btn back-btn full-width" (click)="openUtilities()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>BACK</span>
                </div>
            </button>

            <button mat-flat-button color="accent" class="large-btn" (click)="printLabel('Opened', 0)">
                <div class="btn-content">
                    <mat-icon>calendar_today</mat-icon>
                    <span>OPENED TODAY</span>
                </div>
            </button>

            <button mat-flat-button color="warn" class="large-btn" (click)="printLabel('Expires', 3)">
                <div class="btn-content">
                    <mat-icon>timer</mat-icon>
                    <span>EXP +3 DAYS (Meat)</span>
                </div>
            </button>

            <button mat-flat-button color="warn" class="large-btn" (click)="printLabel('Expires', 7)">
                <div class="btn-content">
                    <mat-icon>timer</mat-icon>
                    <span>EXP +7 DAYS (Deli)</span>
                </div>
            </button>

            <button mat-flat-button color="warn" class="large-btn" (click)="printLabel('Expires', 30)">
                <div class="btn-content">
                    <mat-icon>timer</mat-icon>
                    <span>EXP +1 MONTH</span>
                </div>
            </button>
        </div>

        <!-- SCALE VIEW -->
        <div *ngIf="viewState === 'SCALE'" class="button-grid">
            <button mat-stroked-button class="large-btn back-btn full-width" (click)="closeScale()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>BACK</span>
                </div>
            </button>
            <div class="weight-display-card">
                <div class="weight-value">{{ displayWeight | number:'1.1-2' }}</div>
                <div class="weight-unit">{{ currentUnit === 'g' ? 'GRAMS' : (currentUnit === 'oz' ? 'OUNCES' : 'LBS') }}
                </div>
            </div>
            <div class="scale-controls">
                <button mat-flat-button color="primary" class="large-btn" (click)="tareScale()">
                    <div class="btn-content">
                        <mat-icon>restart_alt</mat-icon>
                        <span>TARE</span>
                    </div>
                </button>
                <button mat-flat-button color="accent" class="large-btn" (click)="toggleUnit()">
                    <div class="btn-content">
                        <mat-icon>swap_vert</mat-icon>
                        <span>{{ currentUnit === 'g' ? 'TO OZ/LBS' : 'TO GRAMS' }}</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- PHONE VIEW -->
        <div *ngIf="viewState === 'PHONE'"
            class="flex flex-col h-full bg-slate-100 dark:bg-zinc-900 p-4 rounded-t-3xl phone-view">
            <!-- Header / Display -->
            <div class="flex items-center justify-between mb-4">
                <button mat-icon-button (click)="closePhone()"><mat-icon>close</mat-icon></button>
                <div class="text-2xl font-mono">{{ dialNumber || '...' }}</div>
                <button mat-icon-button (click)="clearDigit()"><mat-icon>backspace</mat-icon></button>
            </div>

            <!-- Quick Dials -->
            <div class="flex gap-2 overflow-x-auto mb-4 pb-2" *ngIf="pbxConfig?.extensions?.length">
                <button *ngFor="let ext of pbxConfig!.extensions" mat-stroked-button class="shrink-0"
                    (click)="dial(ext.number)">
                    <mat-icon>person</mat-icon> {{ ext.name }}
                </button>
            </div>

            <!-- Keypad -->
            <div class="grid grid-cols-3 gap-4 flex-1">
                <button *ngFor="let d of ['1','2','3','4','5','6','7','8','9','*','0','#']" mat-raised-button
                    class="h-full text-2xl font-bold" (click)="appendDigit(d)">{{d}}</button>
            </div>

            <!-- Call Button -->
            <div class="mt-4">
                <button mat-fab color="primary" class="w-full h-16 text-3xl" (click)="dial(dialNumber)">
                    <mat-icon>call</mat-icon>
                </button>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <div class="footer">
        <span class="pantry-name">{{ pantryName }}</span>
        <span class="connection-status">
            <mat-icon *ngIf="scannerClaimedBy && !amIClaiming" class="mr-2"
                style="vertical-align: bottom; color: #f44336 !important;">qr_code_scanner</mat-icon>
            <span [class.offline]="!isOnline">{{ isOnline ? 'Online' : 'Offline' }}</span>
        </span>
        <div class="footer-end">
            <span class="current-date">{{ currentDate | date:'fullDate' }}</span>
            <button mat-button class="exit-btn" (click)="exitKiosk()">EXIT</button>
        </div>
    </div>
</div>

<!-- CALL OVERLAY -->
<div *ngIf="incomingCall || (callState && callState.state !== 'DISCONNECTED')"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-white dark:bg-zinc-800 rounded-3xl p-8 shadow-2xl w-full max-w-md text-center animate-pulse-soft">
        <div class="mb-4">
            <div
                class="w-24 h-24 rounded-full bg-green-100 text-green-600 flex items-center justify-center mx-auto mb-4 animate-bounce">
                <mat-icon class="text-6xl !w-16 !h-16">phone_in_talk</mat-icon>
            </div>
            <h2 class="text-3xl font-bold mb-2 dark:text-white">
                {{ incomingCall ? 'Incoming Call' : 'Active Call' }}
            </h2>
            <p class="text-xl text-gray-500 dark:text-gray-400">
                {{ incomingCall?.remote_uri || callState?.state || 'Connecting...' }}
            </p>
            <p class="text-lg text-gray-400 dark:text-gray-500 mt-1" *ngIf="incomingCall?.remote_contact">
                {{ incomingCall?.remote_contact }}
            </p>
        </div>

        <div class="flex gap-4 justify-center mt-8">
            <ng-container *ngIf="incomingCall">
                <button mat-fab color="warn" (click)="hangupCall()" class="scale-125">
                    <mat-icon>call_end</mat-icon>
                </button>
                <div class="w-8"></div>
                <button mat-fab class="scale-125 !bg-green-500 text-white" (click)="answerCall()">
                    <mat-icon>call</mat-icon>
                </button>
            </ng-container>

            <ng-container *ngIf="!incomingCall">
                <button mat-fab color="warn" (click)="hangupCall()" class="scale-150">
                    <mat-icon>call_end</mat-icon>
                </button>
            </ng-container>
        </div>
    </div>
</div>