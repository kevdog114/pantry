<div class="kiosk-container">
    <!-- Status Section (Top 50%) -->
    <div class="status-section" [class.scanning]="activeMode !== 'NONE'">
        <h1 class="status-text">{{ status }}</h1>
        <h2 *ngIf="statusSubtext" class="status-subtext">{{ statusSubtext }}</h2>
        <div *ngIf="viewState === 'MAIN' && activeMode === 'NONE' && activeTimers.length > 0"
            class="absolute top-4 right-4 flex flex-col gap-2 z-10 w-64 pointer-events-none">
            <div *ngFor="let timer of activeTimers"
                class="bg-slate-900/90 text-white rounded p-3 flex items-center justify-between shadow-lg border border-slate-700">
                <div>
                    <span class="block text-xs text-gray-400 uppercase tracking-wider">{{ timer.name || 'Timer'
                        }}</span>
                    <span class="block text-2xl font-mono font-bold">{{ formatTimer(timer.remainingSeconds) }}</span>
                </div>
                <mat-icon class="text-orange-500 animate-pulse">timer</mat-icon>
            </div>
        </div>
        <mat-icon *ngIf="activeMode !== 'NONE'" class="pulse-icon">qr_code_scanner</mat-icon>
    </div>

    <!-- Action Section (Bottom 50%) -->
    <div class="action-section">

        <!-- RESTOCK VIEW -->
        <div *ngIf="activeMode === 'RESTOCK'" class="button-grid single-action-grid">
            <button mat-flat-button class="large-btn finish-btn" (click)="finishAction()">
                <div class="btn-content">
                    <mat-icon>check_circle</mat-icon>
                    <span>FINISH RESTOCKING</span>
                </div>
            </button>
        </div>

        <!-- CONSUME VIEW -->
        <div *ngIf="activeMode === 'CONSUME'" class="button-grid single-action-grid">
            <button mat-flat-button class="large-btn finish-btn consume-finish" (click)="finishAction()">
                <div class="btn-content">
                    <mat-icon>check_circle</mat-icon>
                    <span>FINISH CONSUMING</span>
                </div>
            </button>
        </div>

        <!-- INVENTORY VIEW -->
        <div *ngIf="activeMode === 'INVENTORY'" class="button-grid single-action-grid">
            <button mat-stroked-button class="large-btn back-btn" (click)="finishAction()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>BACK</span>
                </div>
            </button>
        </div>

        <!-- MAIN VIEW -->
        <div *ngIf="viewState === 'MAIN' && activeMode === 'NONE'" class="button-grid compact-grid">
            <button mat-flat-button color="primary" class="large-btn" (click)="setMode('RESTOCK')">
                <div class="btn-content">
                    <mat-icon>inventory_2</mat-icon>
                    <span>RESTOCK</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="setMode('CONSUME')">
                <div class="btn-content">
                    <mat-icon>restaurant</mat-icon>
                    <span>CONSUME</span>
                </div>
            </button>

            <button mat-flat-button color="accent" class="large-btn" (click)="openCook()">
                <div class="btn-content">
                    <mat-icon>menu_book</mat-icon>
                    <span>COOK</span>
                </div>
            </button>

            <button mat-flat-button color="accent" class="large-btn inventory-btn" (click)="setMode('INVENTORY')">
                <div class="btn-content">
                    <mat-icon>inventory</mat-icon>
                    <span>INVENTORY</span>
                </div>
            </button>

            <button mat-flat-button class="large-btn utility-btn" (click)="openUtilities()">
                <div class="btn-content">
                    <mat-icon>build</mat-icon>
                    <span>UTILITIES</span>
                </div>
            </button>

            <button mat-flat-button class="large-btn timer-btn" (click)="openTimers()"
                style="background-color: #FF9800; color: white;">
                <div class="btn-content">
                    <mat-icon>timer</mat-icon>
                    <span>TIMERS</span>
                </div>
            </button>
        </div>

        <!-- UTILITIES VIEW -->
        <div *ngIf="viewState === 'UTILITIES'" class="button-grid">
            <button mat-stroked-button class="large-btn back-btn" (click)="closeUtilities()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>MAIN MENU</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="openPrintLabels()">
                <div class="btn-content">
                    <mat-icon>print</mat-icon>
                    <span>PRESETS</span>
                </div>
            </button>

            <button mat-flat-button color="accent" class="large-btn" (click)="openQuickLabel()">
                <div class="btn-content">
                    <mat-icon>edit_note</mat-icon>
                    <span>QUICK LABEL</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="scaleAction()">
                <div class="btn-content">
                    <mat-icon>scale</mat-icon>
                    <span>SCALE</span>
                </div>
            </button>

            <button mat-flat-button color="primary" class="large-btn" (click)="printShoppingList()">
                <div class="btn-content">
                    <mat-icon>list_alt</mat-icon>
                    <span>PRINT LIST</span>
                </div>
            </button>

            <button *ngIf="pbxConfig && pbxConfig.enabled" mat-flat-button class="large-btn phone-btn"
                (click)="openPhone()" style="background-color: #4CAF50; color: white;">
                <div class="btn-content">
                    <mat-icon>phone</mat-icon>
                    <span>PHONE</span>
                </div>
            </button>
        </div>

        <!-- PRINT LABELS VIEW -->
        <div *ngIf="viewState === 'PRINT_LABELS'" class="button-grid compact-grid">
            <button mat-stroked-button class="large-btn back-btn full-width" (click)="openUtilities()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>BACK</span>
                </div>
            </button>

            <button mat-flat-button color="accent" class="large-btn" (click)="printLabel('Opened', 0)">
                <div class="btn-content">
                    <mat-icon>calendar_today</mat-icon>
                    <span>OPENED TODAY</span>
                </div>
            </button>

            <button mat-flat-button color="warn" class="large-btn" (click)="printLabel('Expires', 3)">
                <div class="btn-content">
                    <mat-icon>timer</mat-icon>
                    <span>EXP +3 DAYS (Meat)</span>
                </div>
            </button>

            <button mat-flat-button color="warn" class="large-btn" (click)="printLabel('Expires', 7)">
                <div class="btn-content">
                    <mat-icon>timer</mat-icon>
                    <span>EXP +7 DAYS (Deli)</span>
                </div>
            </button>

            <button mat-flat-button color="warn" class="large-btn" (click)="printLabel('Expires', 30)">
                <div class="btn-content">
                    <mat-icon>timer</mat-icon>
                    <span>EXP +1 MONTH</span>
                </div>
            </button>
        </div>

        <!-- QUICK LABEL VIEW -->
        <div *ngIf="viewState === 'QUICK_LABEL'" class="flex flex-col h-full gap-4 p-4">
            <!-- Back Button -->
            <div class="h-20 shrink-0">
                <button mat-stroked-button class="large-btn back-btn full-width" (click)="openUtilities()">
                    <div class="btn-content">
                        <mat-icon>arrow_back</mat-icon>
                        <span>BACK</span>
                    </div>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                <!-- Label Type Grid -->
                <div class="grid grid-cols-2 gap-4 h-64 shrink-0">
                    <button *ngFor="let type of quickLabelTypes" mat-flat-button
                        [color]="quickLabelSelectedType === type ? 'primary' : 'warn'"
                        [style.background-color]="quickLabelSelectedType !== type ? '#37474f' : ''" class="large-btn"
                        (click)="selectQuickLabelType(type)">
                        <div class="btn-content">
                            <mat-icon>{{ getQuickLabelIcon(type) }}</mat-icon>
                            <span>{{ type | uppercase }}</span>
                        </div>
                    </button>
                </div>

                <!-- Date & Print Row -->
                <div class="flex-1 grid grid-cols-2 gap-4">
                    <!-- Date Selection Card -->
                    <mat-card class="flex flex-col justify-center p-6 bg-slate-800 text-white rounded-2xl">
                        <h3 class="text-2xl font-bold mb-4 text-center text-gray-300">DATE</h3>
                        <mat-form-field appearance="outline" class="w-full text-3xl">
                            <mat-label>Select Date</mat-label>
                            <input matInput [matDatepicker]="picker" [(ngModel)]="quickLabelDate">
                            <mat-datepicker-toggle matIconSuffix [for]="picker"
                                class="scale-150"></mat-datepicker-toggle>
                            <mat-datepicker #picker touchUi></mat-datepicker>
                        </mat-form-field>
                        <div class="text-center mt-4 text-gray-400 font-mono">
                            {{ quickLabelDate | date:'fullDate' }}
                        </div>
                    </mat-card>

                    <!-- Print Button -->
                    <button mat-flat-button color="accent" class="large-btn finish-btn h-full"
                        (click)="printCustomQuickLabel()" [disabled]="!quickLabelSelectedType || !quickLabelDate">
                        <div class="btn-content">
                            <mat-icon style="font-size: 64px; height: 64px; width: 64px;">print</mat-icon>
                            <span>PRINT LABEL</span>
                        </div>
                    </button>
                </div>

                <div class="text-center text-gray-500 pb-2">
                    Format: {{labelSizeCode === '23mm' ? '23mm Square' : 'Continuous'}}
                </div>
            </div>
        </div>

        <!-- SCALE VIEW -->
        <div *ngIf="viewState === 'SCALE'" class="button-grid">
            <button mat-stroked-button class="large-btn back-btn full-width" (click)="closeScale()">
                <div class="btn-content">
                    <mat-icon>arrow_back</mat-icon>
                    <span>BACK</span>
                </div>
            </button>
            <div class="weight-display-card">
                <div class="weight-value">{{ displayWeight | number:'1.1-2' }}</div>
                <div class="weight-unit">{{ currentUnit === 'g' ? 'GRAMS' : (currentUnit === 'oz' ? 'OUNCES' : 'LBS') }}
                </div>
            </div>
            <div class="scale-controls">
                <button mat-flat-button color="primary" class="large-btn" (click)="tareScale()">
                    <div class="btn-content">
                        <mat-icon>restart_alt</mat-icon>
                        <span>TARE</span>
                    </div>
                </button>
                <button mat-flat-button color="accent" class="large-btn" (click)="toggleUnit()">
                    <div class="btn-content">
                        <mat-icon>swap_vert</mat-icon>
                        <span>{{ currentUnit === 'g' ? 'TO OZ/LBS' : 'TO GRAMS' }}</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- TIMERS VIEW -->
        <div *ngIf="viewState === 'TIMERS'" class="flex flex-col h-full bg-slate-900 text-white p-4">
            <div class="h-20 shrink-0 mb-4">
                <button mat-stroked-button class="large-btn back-btn full-width" (click)="closeTimers()">
                    <div class="btn-content">
                        <mat-icon>arrow_back</mat-icon>
                        <span>BACK</span>
                    </div>
                </button>
            </div>

            <div class="bg-slate-800 rounded-xl p-4 mb-4">
                <h3 class="text-xl font-bold mb-4 text-gray-300">Set New Timer</h3>
                <div class="grid grid-cols-5 gap-2">
                    <button mat-flat-button color="primary" class="h-16 text-xl" (click)="createTimer(5)">5m</button>
                    <button mat-flat-button color="primary" class="h-16 text-xl" (click)="createTimer(10)">10m</button>
                    <button mat-flat-button color="primary" class="h-16 text-xl" (click)="createTimer(15)">15m</button>
                    <button mat-flat-button color="primary" class="h-16 text-xl" (click)="createTimer(30)">30m</button>
                    <button mat-flat-button color="primary" class="h-16 text-xl" (click)="createTimer(60)">1h</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto space-y-3 bg-slate-800/50 rounded-xl p-4">
                <h3 class="text-xl font-bold mb-2 text-gray-300">Active Timers</h3>
                <div *ngFor="let timer of activeTimers"
                    class="bg-slate-700 rounded-xl p-4 flex items-center justify-between border-l-4 border-orange-500">
                    <div>
                        <div class="text-gray-300 text-sm">{{ timer.name || 'Timer' }}</div>
                        <div class="text-4xl font-mono font-bold">{{ formatTimer(timer.remainingSeconds) }}</div>
                    </div>
                    <button mat-icon-button color="warn" class="scale-150 w-16 h-16" (click)="deleteTimer(timer.id)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </div>
                <div *ngIf="activeTimers.length === 0"
                    class="flex flex-col items-center justify-center h-40 text-gray-500">
                    <mat-icon class="text-6xl text-gray-700 mb-2">timer_off</mat-icon>
                    <span>No active timers</span>
                </div>
            </div>
        </div>

        <!-- PHONE VIEW -->
        <div *ngIf="viewState === 'PHONE'"
            class="flex flex-col h-full bg-slate-100 dark:bg-zinc-900 p-4 rounded-t-3xl phone-view">
            <!-- Header / Display -->
            <div class="flex items-center justify-between mb-4">
                <button mat-icon-button (click)="closePhone()"><mat-icon>close</mat-icon></button>
                <div class="text-2xl font-mono">{{ dialNumber || '...' }}</div>
                <button mat-icon-button (click)="clearDigit()"><mat-icon>backspace</mat-icon></button>
            </div>

            <!-- Quick Dials -->
            <div class="flex gap-2 overflow-x-auto mb-4 pb-2" *ngIf="pbxConfig?.extensions?.length">
                <button *ngFor="let ext of pbxConfig!.extensions" mat-stroked-button class="shrink-0"
                    (click)="dial(ext.number)">
                    <mat-icon>person</mat-icon> {{ ext.name }}
                </button>
            </div>

            <!-- Keypad -->
            <div class="grid grid-cols-3 gap-4 flex-1">
                <button *ngFor="let d of ['1','2','3','4','5','6','7','8','9','*','0','#']" mat-raised-button
                    class="h-full text-2xl font-bold" (click)="appendDigit(d)">{{d}}</button>
            </div>

            <!-- Call Button -->
            <div class="mt-4">
                <button mat-fab color="primary" class="w-full h-16 text-3xl" (click)="dial(dialNumber)">
                    <mat-icon>call</mat-icon>
                </button>
            </div>
        </div>

        <!-- COOK VIEW -->
        <div *ngIf="viewState === 'COOK'"
            class="flex flex-col h-full bg-slate-900 text-white p-4 overflow-hidden relative">

            <!-- Top Bar -->
            <div class="flex items-center justify-between mb-4 shrink-0">
                <button mat-stroked-button color="warn" (click)="closeCook()">
                    <mat-icon>arrow_back</mat-icon> EXIT COOK MODE
                </button>
                <div *ngIf="selectedRecipe" class="text-xl font-bold truncate ml-4">{{ selectedRecipe.title }}</div>
            </div>

            <!-- Empty State -->
            <div *ngIf="!selectedRecipe && availableInstructions.length === 0"
                class="flex-1 flex flex-col items-center justify-center text-gray-400">
                <mat-icon style="font-size: 96px; width: 96px; height: 96px;"
                    class="mb-4 opacity-50">qr_code_scanner</mat-icon>
                <h2 class="text-3xl font-light">Scan Recipe or Product Barcode</h2>
            </div>

            <!-- Instruction Selection -->
            <div *ngIf="!selectedRecipe && availableInstructions.length > 0" class="flex-1 overflow-y-auto p-8">
                <h2 class="text-3xl font-bold mb-8 text-center">Select Cooking Instructions</h2>
                <div class="grid grid-cols-2 gap-6">
                    <button *ngFor="let instruction of availableInstructions" mat-flat-button color="primary"
                        class="h-32 text-xl shadow-lg transform transition active:scale-95"
                        (click)="selectInstruction(instruction)">
                        <div class="flex flex-col items-center gap-2">
                            <mat-icon class="scale-150 mb-2">menu_book</mat-icon>
                            <span>{{ (instruction.name || instruction.title).split(' - ').pop() }}</span>
                            <span class="text-sm font-normal opacity-75" *ngIf="instruction.totalTime">
                                {{ instruction.totalTime }} mins
                            </span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Recipe Content -->
            <div *ngIf="selectedRecipe" class="flex-1 overflow-y-auto grid grid-cols-12 gap-4">
                <!-- Ingredients -->
                <div class="col-span-4 bg-slate-800 rounded-xl p-4">
                    <h3 class="text-lg font-bold mb-3 border-b border-slate-700 pb-2">Ingredients</h3>
                    <ul class="space-y-2 text-sm">
                        <li *ngFor="let ing of selectedRecipe.ingredients" class="flex justify-between">
                            <span>{{ ing.amount }} {{ ing.unit }}</span>
                            <span class="text-gray-300 truncate ml-2">{{ ing.name }}</span>
                        </li>
                    </ul>
                </div>

                <!-- Steps -->
                <div class="col-span-4 bg-slate-800 rounded-xl p-4 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-3 border-b border-slate-700 pb-2">Method</h3>
                    <div class="space-y-4">
                        <div *ngFor="let step of selectedRecipe.steps" class="flex gap-3">
                            <div
                                class="shrink-0 w-6 h-6 rounded-full bg-primary-500 flex items-center justify-center text-xs font-bold">
                                {{ step.stepNumber }}</div>
                            <p class="text-sm leading-relaxed text-gray-200">{{ step.description }}</p>
                        </div>
                    </div>
                </div>

                <!-- Actions & Timers -->
                <div class="col-span-4 flex flex-col gap-4">
                    <!-- Main Actions -->
                    <div class="bg-slate-800 rounded-xl p-4">
                        <button mat-flat-button color="accent" class="w-full h-16 text-lg mb-4"
                            (click)="printRecipeReceipt()">
                            <mat-icon class="mr-2">receipt_long</mat-icon> Print Receipt
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-slate-800 rounded-xl p-4 flex-1" *ngIf="selectedRecipe.quickActions?.length">
                        <h3 class="text-lg font-bold mb-3 border-b border-slate-700 pb-2">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button *ngFor="let action of selectedRecipe.quickActions" mat-stroked-button
                                color="primary" class="h-16 !whitespace-normal !leading-tight py-2"
                                (click)="startQuickAction(action)">
                                <div class="flex flex-col items-center">
                                    <mat-icon>{{ action.type === 'weigh' ? 'scale' : 'timer' }}</mat-icon>
                                    <span class="text-xs">{{ action.name }}</span>
                                    <span class="text-xs font-mono">{{ action.value }}{{ action.type === 'weigh' ? 'g' : 'm' }}</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Active Timers -->
                    <div class="bg-slate-800 rounded-xl p-4 flex-1" *ngIf="activeTimers.length > 0">
                        <h3 class="text-lg font-bold mb-3 border-b border-slate-700 pb-2 text-orange-400">Timers</h3>
                        <div class="space-y-2">
                            <div *ngFor="let timer of activeTimers"
                                class="bg-slate-700 rounded p-3 flex items-center justify-between animate-pulse-slow">
                                <div>
                                    <div class="text-xs text-gray-400">{{ timer.name }}</div>
                                    <div class="text-xl font-mono">{{ formatTimer(timer.remainingSeconds) }}</div>
                                </div>
                                <button mat-icon-button color="warn"
                                    (click)="removeTimer(timer)"><mat-icon>close</mat-icon></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <div class="footer">
        <span class="pantry-name">{{ pantryName }}</span>
        <span class="connection-status">
            <mat-icon *ngIf="scannerClaimedBy && !amIClaiming" class="mr-2"
                style="vertical-align: bottom; color: #f44336 !important;">qr_code_scanner</mat-icon>
            <span [class.offline]="!isOnline">{{ isOnline ? 'Online' : 'Offline' }}</span>
        </span>
        <div class="footer-end">
            <span class="current-date">{{ currentDate | date:'fullDate' }}</span>
            <button mat-button class="exit-btn" (click)="exitKiosk()">EXIT</button>
        </div>
    </div>
</div>

<!-- CALL OVERLAY -->
<div *ngIf="incomingCall || (callState && callState.state !== 'DISCONNECTED')"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-white dark:bg-zinc-800 rounded-3xl p-8 shadow-2xl w-full max-w-md text-center animate-pulse-soft">
        <div class="mb-4">
            <div
                class="w-24 h-24 rounded-full bg-green-100 text-green-600 flex items-center justify-center mx-auto mb-4 animate-bounce">
                <mat-icon class="text-6xl !w-16 !h-16">phone_in_talk</mat-icon>
            </div>
            <h2 class="text-3xl font-bold mb-2 dark:text-white">
                {{ incomingCall ? 'Incoming Call' : 'Active Call' }}
            </h2>
            <p class="text-xl text-gray-500 dark:text-gray-400">
                {{ incomingCall?.remote_uri || callState?.state || 'Connecting...' }}
            </p>
            <p class="text-lg text-gray-400 dark:text-gray-500 mt-1" *ngIf="incomingCall?.remote_contact">
                {{ incomingCall?.remote_contact }}
            </p>
        </div>

        <div class="flex gap-4 justify-center mt-8">
            <ng-container *ngIf="incomingCall">
                <button mat-fab color="warn" (click)="hangupCall()" class="scale-125">
                    <mat-icon>call_end</mat-icon>
                </button>
                <div class="w-8"></div>
                <button mat-fab class="scale-125 !bg-green-500 text-white" (click)="answerCall()">
                    <mat-icon>call</mat-icon>
                </button>
            </ng-container>

            <ng-container *ngIf="!incomingCall">
                <button mat-fab color="warn" (click)="hangupCall()" class="scale-150">
                    <mat-icon>call_end</mat-icon>
                </button>
            </ng-container>
        </div>
    </div>
</div>