<div class="page-container" *ngIf="product">
    <!-- Header Section -->
    <div class="header-section">
        <h1 class="page-title">{{ isCreate ? 'New Product' : 'Edit Product' }}</h1>
        <div class="action-bar">
            <button mat-stroked-button color="warn" (click)="delete()" *ngIf="!isCreate">
                <mat-icon>delete</mat-icon> Delete
            </button>
            <button mat-flat-button color="primary" (click)="save()">
                <mat-icon>save</mat-icon> Save Changes
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column: Basic Info & Lifespan -->
        <div class="col-lg-8">
            <!-- Basic Details Card -->
            <mat-card class="section-card">
                <mat-card-header>
                    <mat-card-title>Basic Information</mat-card-title>
                </mat-card-header>
                <div class="card-content-padded">
                    <div class="form-grid">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Product Title</mat-label>
                            <input name="title" matInput [(ngModel)]="product.title" placeholder="Ex. Whole Milk" />
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Track Amount By</mat-label>
                            <mat-select [(ngModel)]="product.trackCountBy" name="trackCountBy">
                                <mat-option value="quantity">Quantity (Units)</mat-option>
                                <mat-option value="weight">Weight</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <div class="d-flex align-center mt-2 gap-2" style="gap: 8px; flex-wrap: wrap;">
                        <button mat-stroked-button color="primary" (click)="askGeminiProductDetails()"
                            [disabled]="!product.title || isAskingAi">
                            <mat-icon *ngIf="!isAskingAi">auto_awesome</mat-icon>
                            <mat-spinner *ngIf="isAskingAi" [diameter]="20"
                                style="display:inline-block; vertical-align: middle; margin-right: 8px;"></mat-spinner>
                            {{ isAskingAi ? 'Asking AI...' : 'Auto-fill Details with AI' }}
                        </button>
                        <button mat-stroked-button color="accent" (click)="photoInput.click()"
                            [disabled]="isAnalyzingPhoto">
                            <mat-icon *ngIf="!isAnalyzingPhoto">photo_camera</mat-icon>
                            <mat-spinner *ngIf="isAnalyzingPhoto" [diameter]="20"
                                style="display:inline-block; vertical-align: middle; margin-right: 8px;"></mat-spinner>
                            {{ isAnalyzingPhoto ? 'Analyzing photo...' : 'Add details from photo' }}
                        </button>
                        <input #photoInput type="file" accept="image/*" capture="environment"
                            (change)="onPhotoSelected($event)" style="display: none;" />
                        <button mat-stroked-button (click)="showBarcodeInput = !showBarcodeInput"
                            [disabled]="isLookingUpBarcode">
                            <mat-icon *ngIf="!isLookingUpBarcode">qr_code_scanner</mat-icon>
                            <mat-spinner *ngIf="isLookingUpBarcode" [diameter]="20"
                                style="display:inline-block; vertical-align: middle; margin-right: 8px;"></mat-spinner>
                            {{ isLookingUpBarcode ? 'Looking up barcode...' : 'Add details from barcode' }}
                        </button>
                    </div>

                    <!-- Barcode Input Panel -->
                    <div *ngIf="showBarcodeInput" class="mt-3"
                        style="background: var(--mat-sys-surface-container); border-radius: 12px; padding: 16px;">
                        <form (ngSubmit)="lookupBarcode()" class="d-flex align-items-center" style="gap: 8px;">
                            <mat-form-field appearance="outline" class="flex-grow-1 density-compact"
                                subscriptSizing="dynamic">
                                <mat-label>Barcode Number</mat-label>
                                <input matInput [(ngModel)]="barcodeInput" name="barcode"
                                    placeholder="e.g. 0049000006346" autofocus>
                                <mat-icon matPrefix>qr_code</mat-icon>
                            </mat-form-field>
                            <button mat-flat-button color="primary" type="submit"
                                [disabled]="!barcodeInput || isLookingUpBarcode">
                                <mat-icon>search</mat-icon> Lookup
                            </button>
                        </form>
                    </div>
                </div>
            </mat-card>

            <!-- Lifespan Card -->
            <mat-card class="section-card">
                <mat-card-header>
                    <mat-card-title>Storage & Shelf Life</mat-card-title>
                </mat-card-header>
                <div class="card-content-padded">
                    <div class="lifespan-grid">
                        <mat-form-field appearance="outline">
                            <mat-label>Freezer (Days)</mat-label>
                            <span matPrefix><mat-icon class="mr-2">ac_unit</mat-icon> &nbsp;</span>
                            <input name="freezerLifespanDays" type="number" matInput
                                [(ngModel)]="product.freezerLifespanDays">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Refrigerator (Days)</mat-label>
                            <span matPrefix><mat-icon class="mr-2">kitchen</mat-icon> &nbsp;</span>
                            <input name="refrigeratorLifespanDays" type="number" matInput
                                [(ngModel)]="product.refrigeratorLifespanDays">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Opened (Days)</mat-label>
                            <span matPrefix><mat-icon class="mr-2">timelapse</mat-icon> &nbsp;</span>
                            <input name="openedLifespanDays" type="number" matInput
                                [(ngModel)]="product.openedLifespanDays">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Pantry (Shelf Life)</mat-label>
                            <span matPrefix><mat-icon class="mr-2">inventory_2</mat-icon> &nbsp;</span>
                            <input name="pantryLifespanDays" type="number" matInput
                                [(ngModel)]="product.pantryLifespanDays">
                        </mat-form-field>
                    </div>
                </div>
            </mat-card>

            <!-- Barcodes Section -->
            <mat-card class="section-card">
                <div class="row d-flex align-items-center justify-content-between px-3 pt-3">
                    <div class="col">
                        <mat-card-title>Barcodes</mat-card-title>
                    </div>
                    <div class="col-auto">
                        <button mat-stroked-button (click)="addBarcode()">
                            <mat-icon>add</mat-icon> Add Barcode
                        </button>
                    </div>
                </div>

                <div class="card-content-padded">
                    @if (product.barcodes.length === 0) {
                    <div class="text-center text-muted p-4">
                        <mat-icon
                            style="font-size: 48px; width: 48px; height: 48px; opacity: 0.5;">qr_code_scanner</mat-icon>
                        <p>No barcodes linked to this product yet.</p>
                    </div>
                    }

                    @for(barcode of product.barcodes; track barcode.barcode) {
                    <div class="barcode-item">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <mat-form-field appearance="outline" class="w-100 density-compact">
                                    <mat-label>Barcode</mat-label>
                                    <input [name]="'barcode-' + $index" matInput [(ngModel)]="barcode.barcode">
                                </mat-form-field>
                            </div>
                            <div class="col-md-3">
                                <mat-form-field appearance="outline" class="w-100 density-compact">
                                    <mat-label>Brand</mat-label>
                                    <input [name]="'brand-' + $index" matInput [(ngModel)]="barcode.brand">
                                </mat-form-field>
                            </div>
                            <div class="col-md-4">
                                <app-tags category="Category" [selectedTags]="barcode.tags"
                                    (selectionChange)="barcode.tags = $event"></app-tags>
                            </div>
                            <div class="col-md-2 barcode-actions">
                                <button mat-icon-button color="warn" (click)="removeBarcode(barcode)"
                                    matTooltip="Remove Barcode">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-md-12">
                                <mat-form-field appearance="outline" class="w-100 density-compact">
                                    <mat-label>Description / Variant Name</mat-label>
                                    <input [name]="'description-' + $index" matInput [(ngModel)]="barcode.description"
                                        placeholder="e.g. 12-pack">
                                </mat-form-field>
                            </div>
                            <div class="col-md-4" *ngIf="product.trackCountBy === 'weight'">
                                <mat-form-field appearance="outline" class="w-100 density-compact">
                                    <mat-label>Tare Weight (g)</mat-label>
                                    <input [name]="'tareWeight-' + $index" matInput type="number"
                                        [(ngModel)]="barcode.tareWeight">
                                </mat-form-field>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </mat-card>
        </div>

        <!-- Right Column: Images -->
        <div class="col-lg-4">
            <mat-card class="section-card">
                <mat-card-header>
                    <mat-card-title>Product Images</mat-card-title>
                </mat-card-header>
                <div class="card-content-padded">
                    <div class="image-gallery">
                        <!-- Images Loop -->
                        <div class="image-card" *ngFor="let file of product.files" (click)="openImage(file)">
                            <img [src]="GetFileDownloadUrl(file)" [alt]="file.filename">
                            <div class="image-actions" (click)="$event.stopPropagation()">
                                <a [href]="GetFileDownloadUrl(file)" target="_blank" mat-icon-button class="text-white">
                                    <mat-icon>download</mat-icon>
                                </a>
                                <button mat-icon-button color="warn" (click)="removeImage(file)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                        </div>

                        <!-- Generate with AI Button -->
                        <button class="image-card add-image-card generate-image-card" (click)="generateImage()"
                            [disabled]="isGeneratingImage || !product.title" matTooltip="Generate AI Image">
                            <mat-spinner *ngIf="isGeneratingImage" [diameter]="30" color="accent"></mat-spinner>
                            <mat-icon *ngIf="!isGeneratingImage">auto_awesome</mat-icon>
                            <span *ngIf="!isGeneratingImage">Generate</span>
                        </button>

                        <!-- Upload Button -->
                        <div class="image-card add-image-card" (click)="fileInput.click()">
                            <mat-icon>cloud_upload</mat-icon>
                            <span>Upload</span>
                            <input #fileInput type="file" multiple (change)="browsedFiles($event)"
                                [(ngModel)]="inputValue" style="display: none;" />
                        </div>
                    </div>
                </div>
            </mat-card>
        </div>
    </div>
</div>