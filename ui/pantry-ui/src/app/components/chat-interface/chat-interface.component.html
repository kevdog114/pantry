<div class="chat-interface-container">
    <div class="messages-area" #scrollContainer>
        <div *ngIf="messages.length === 0 && showWelcomeMessage" class="welcome-message">
            <h2 class="gradient-text">Hello, Chef</h2>
            <p>How can I help you cook today?</p>
        </div>

        <div *ngFor="let message of messages" class="message" [class.user-message]="message.sender === 'You'"
            [class.bot-message]="message.sender !== 'You'">

            <span class="sender-label" *ngIf="message.sender !== 'You'">Smart Chat</span>

            <div class="message-content-group">
                <div *ngFor="let item of message.contents" class="message-item">

                    <!-- Text/Chat Message -->
                    <div *ngIf="item.type === 'chat'" class="content-bubble"
                        [class.user-bubble]="message.sender === 'You'" [class.bot-bubble]="message.sender !== 'You'">
                        <markdown [data]="item.text"></markdown>

                        <!-- Speak button for AI responses -->
                        <button *ngIf="message.sender !== 'You' && item.text" mat-icon-button class="speak-btn"
                            (click)="onSpeak(item.text!)" title="Read Aloud">
                            <mat-icon style="font-size: 18px; width: 18px; height: 18px;">volume_up</mat-icon>
                        </button>
                    </div>

                    <!-- Image Message -->
                    <div *ngIf="item.type === 'image'" class="message-image">
                        <img [src]="item.imageUrl" alt="Attached Image">
                    </div>

                    <!-- Recipe Message -->
                    <div *ngIf="item.type === 'recipe' && item.recipe">
                        <app-recipe-card [recipe]="item.recipe"></app-recipe-card>
                    </div>

                    <!-- Tool Call Message -->
                    <div *ngIf="item.type === 'tool_call' && item.toolCall" class="tool-call-container">
                        <mat-icon class="tool-icon">build</mat-icon>
                        <span class="tool-display-name">{{ item.toolCall.displayName || item.toolCall.name }}</span>
                        <span class="tool-duration" *ngIf="item.durationMs">({{ item.durationMs }}ms)</span>
                    </div>
                </div>
            </div>
            <!-- Metadata & Timestamp -->
            <div class="message-footer">
                <div class="message-meta" *ngIf="message.meta">
                    <span class="meta-item" *ngIf="message.meta.modelName" [title]="'Model: ' + message.meta.modelName">
                        <mat-icon>smart_toy</mat-icon>
                        {{ message.meta.modelName }}
                    </span>
                    <span class="meta-item highlight" *ngIf="message.meta.usingCache" title="Context Cache Used">
                        <mat-icon>bolt</mat-icon>
                        Cached
                    </span>
                    <span class="meta-item" *ngIf="message.meta.usageMetadata?.totalTokenCount"
                        [title]="'Total Tokens: ' + message.meta.usageMetadata?.totalTokenCount">
                        <mat-icon>data_usage</mat-icon>
                        <!-- Only show cached breakdown if we actually reused an existing cache -->
                        <ng-container
                            *ngIf="message.meta.usingCache && message.meta.usageMetadata?.cachedContentTokenCount; else totalOnly">
                            <span class="token-split">
                                {{ (message.meta.usageMetadata?.totalTokenCount || 0) -
                                (message.meta.usageMetadata?.cachedContentTokenCount || 0) }}
                                <span class="cached-val">(+{{ (message.meta.usageMetadata?.cachedContentTokenCount || 0)
                                    / 1000 | number:'1.0-1' }}k)</span>
                            </span>
                        </ng-container>
                        <ng-template #totalOnly>
                            {{ message.meta.usageMetadata?.totalTokenCount }}
                        </ng-template>
                    </span>
                </div>
                <span class="message-timestamp" *ngIf="message.timestamp">
                    {{ message.timestamp | date:'shortTime' }} {{ message.timestamp | date:'MM/dd' }}
                </span>
            </div>
        </div>
    </div>

    <!-- Loading Indicator - Above input box -->
    <div *ngIf="isLoading" class="loading-indicator">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="loading-text">{{ loadingText }}</span>
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <app-smart-chat-input [placeholder]="placeholder" [disabled]="isLoading" [enableAudio]="enableAudio"
            [autoSendAudio]="autoSendAudio" (send)="handleSend($event)">
        </app-smart-chat-input>
    </div>
</div>