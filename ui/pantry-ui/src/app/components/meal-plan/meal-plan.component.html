<div class="meal-plan-container">
    <div class="header">
        <h1>Weekly Meal Plan</h1>
        <div class="header-actions">
            <button mat-stroked-button color="primary" (click)="runSousChef()" [disabled]="isPlanningLogistics">
                <mat-icon *ngIf="!isPlanningLogistics">psychology</mat-icon>
                <mat-spinner *ngIf="isPlanningLogistics" diameter="20"
                    style="margin-right: 8px; display: inline-block; vertical-align: middle;"></mat-spinner>
                <span class="desktop-label">{{ isPlanningLogistics ? 'Processing...' : 'Plan Logistics' }}</span>
                <span class="mobile-label">{{ isPlanningLogistics ? '...' : 'Plan Logistics' }}</span>
            </button>
            <div class="week-selector ms-2">
                <button mat-icon-button (click)="previousWeek()" aria-label="Previous Week">
                    <mat-icon>chevron_left</mat-icon>
                </button>
                <button mat-button (click)="resetToToday()">Today</button>
                <button mat-icon-button (click)="nextWeek()" aria-label="Next Week">
                    <mat-icon>chevron_right</mat-icon>
                </button>
            </div>
        </div>
    </div>

    <div class="calendar-grid" cdkDropListGroup>
        <div *ngFor="let day of days" class="day-card">

            <div class="card-header-content">
                <div class="date-group">
                    <h2 class="day-name">{{ day | date:'EEEE' }}</h2>
                    <span class="day-date">{{ day | date:'MMM d' }}</span>
                </div>
                <div class="weather-info" *ngIf="getWeather(day) as w" [matTooltip]="getWeatherTooltip(w)">
                    <mat-icon class="weather-icon">{{getWeatherIcon(w.condition)}}</mat-icon>
                    <span class="temps" *ngIf="w.highTemp !== null && w.lowTemp !== null">
                        {{w.highTemp}}°/{{w.lowTemp}}°
                    </span>
                    <span class="precip" *ngIf="w.precipitationChance > 0">
                        <mat-icon style="font-size: 14px; width: 14px; height: 14px;">water_drop</mat-icon>
                        {{w.precipitationChance}}%
                    </span>
                </div>
            </div>

            <div class="card-body">
                <!-- Unassigned Section (Only if items exist) -->
                <div class="meal-type-section" *ngIf="getMealsForDayUnassigned(day).length > 0">
                    <div class="meal-type-header">
                        <span>Unassigned</span>
                    </div>
                    <div class="meals-list" cdkDropList [cdkDropListData]="getMealsForDayUnassigned(day)"
                        [id]="'meal-list-' + day.toISOString() + '--Unassigned'" (cdkDropListDropped)="drop($event)">

                        <div *ngFor="let plan of getMealsForDayUnassigned(day)" class="meal-item" cdkDrag
                            [cdkDragData]="plan" [class.highlighted]="isHighlighted(plan.id)">

                            <!-- Reusing the meal item content template -->
                            <ng-container
                                *ngTemplateOutlet="mealItemTemplate; context: {$implicit: plan}"></ng-container>

                        </div>
                    </div>
                </div>

                <!-- Iterate Meal Types -->
                <div *ngFor="let type of mealTypes" class="meal-type-section">
                    <div class="meal-type-header">
                        <span>{{type}}</span>
                        <button mat-icon-button class="add-mini-btn" [matMenuTriggerFor]="typeAddMenu">
                            <mat-icon style="font-size: 18px;">add</mat-icon>
                        </button>
                        <mat-menu #typeAddMenu="matMenu">
                            <button mat-menu-item (click)="openAddItemDialog(day, 'recipe', type)">
                                <mat-icon>restaurant_menu</mat-icon> Recipe
                            </button>
                            <button mat-menu-item (click)="openAddItemDialog(day, 'product', type)">
                                <mat-icon>kitchen</mat-icon> Product
                            </button>
                        </mat-menu>
                    </div>

                    <div class="meals-list type-list" cdkDropList [cdkDropListData]="getMealsForDayAndType(day, type)"
                        [id]="'meal-list-' + day.toISOString() + '--' + type" (cdkDropListDropped)="drop($event)">

                        <div *ngFor="let plan of getMealsForDayAndType(day, type)" class="meal-item" cdkDrag
                            [cdkDragData]="plan" [class.highlighted]="isHighlighted(plan.id)">
                            <ng-container
                                *ngTemplateOutlet="mealItemTemplate; context: {$implicit: plan}"></ng-container>
                        </div>

                        <!-- Empty placeholder to allow dropping -->
                        <div class="empty-drop-placeholder" *ngIf="getMealsForDayAndType(day, type).length === 0"></div>
                    </div>
                </div>

                <!-- Template for Meal Item Content to avoid duplication -->
                <ng-template #mealItemTemplate let-plan>
                    <div class="meal-header">
                        <div>
                            <span class="meal-title-text" [routerLink]="plan.recipe ? ['/recipes', plan.recipeId] : []"
                                [style.cursor]="plan.recipe ? 'pointer' : 'default'">
                                {{ plan.recipe?.title || plan.product?.title || 'Unknown Item' }}
                                <span *ngIf="plan.isLeftover" class="badge bg-secondary ms-1"
                                    style="font-size: 0.7em; vertical-align: middle;">Leftover</span>
                                <span *ngIf="hasLeftoverShortage(plan)" class="badge bg-danger ms-1"
                                    style="font-size: 0.7em; vertical-align: middle;"
                                    matTooltip="Planned quantity exceeds available leftovers">
                                    Shortage!
                                </span>
                                <span *ngIf="plan.recipe?.yield && !plan.isLeftover" class="text-muted small ms-1"
                                    style="font-size: 0.85em;">
                                    (Yields: {{plan.recipe?.yield}} | {{ getRemainingServings(plan) }} left)
                                </span>
                            </span>
                            <div *ngIf="hasPrepTasks(plan)" class="prep-indicator text-muted"
                                style="font-size: 0.8rem; display: flex; align-items: center; margin-top: 2px;">
                                <mat-icon
                                    style="font-size: 14px; width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;">content_cut</mat-icon>
                                <span>Requires prep</span>
                            </div>
                            <div *ngIf="plan.product || plan.isLeftover"
                                (click)="$event.stopPropagation(); editQuantity(plan)"
                                class="quantity-badge clickable-badge" matTooltip="Edit Quantity">
                                x{{ plan.quantity || 1 }}
                            </div>
                        </div>
                        <button mat-icon-button class="action-btn" color="warn"
                            (click)="$event.stopPropagation(); removeMeal(plan)">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>

                    <div class="indicators" *ngIf="getMissingIngredients(plan).length > 0">
                        <!-- Purchase Notice -->
                        <div *ngIf="getMissingIngredients(plan).length > 0" class="badge buy">
                            <mat-icon>shopping_cart</mat-icon>
                            <span>Buy: {{ getMissingIngredients(plan).join(', ') }}</span>
                        </div>
                    </div>
                </ng-template>

                <!-- Prep Tasks Section -->
                <div class="prep-tasks-section mb-3" *ngIf="getPrepTasksForDate(day).length > 0">
                    <div class="prep-header mb-1">
                        <mat-icon inline="true" class="small-icon">checklist</mat-icon> <strong>Prep
                            Checklist</strong>
                    </div>
                    <div *ngFor="let task of getPrepTasksForDate(day)" class="prep-task-item"
                        (click)="toggleHighlight(task.relatedMealPlanIds || task.relatedMealPlanId)"
                        [class.highlighted]="false" style="cursor: pointer;"
                        [title]="task.relatedRecipeTitle ? 'Click to highlight ' + task.relatedRecipeTitle : ''">

                        <!-- Dynamic Icon -->
                        <mat-icon inline="true" class="task-icon"
                            [class.text-info]="task.type === 'FREEZE' || task.type === 'THAW'"
                            [class.text-muted]="task.type === 'PREP'">
                            {{ task.icon || 'arrow_right' }}
                        </mat-icon>

                        <div class="task-details">
                            <span class="task-desc">{{ task.description || task.task }}</span>
                            <div class="task-meta text-muted small" *ngIf="task.relatedRecipeTitle">
                                <span *ngIf="task.relatedMealDates && task.relatedMealDates.length > 0; else noDate">
                                    For {{task.relatedRecipeTitle}} on {{ task.relatedMealDates.join(', ') }}
                                </span>
                                <ng-template #noDate>
                                    For {{task.relatedRecipeTitle}}
                                </ng-template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shopping Trips Drop List -->
                <div class="shopping-trips-section mb-3" cdkDropList
                    [cdkDropListData]="shoppingTrips[day.toDateString()]" [id]="'shopping-' + day.toISOString()"
                    (cdkDropListDropped)="drop($event)">

                    <div *ngIf="shoppingTrips[day.toDateString()]?.length">
                        <div *ngFor="let trip of shoppingTrips[day.toDateString()]"
                            class="meal-item shopping-trip-container" cdkDrag [cdkDragData]="trip">
                            <mat-expansion-panel class="shopping-trip-panel"
                                [class.no-items]="!trip.items || trip.items.length === 0">
                                <mat-expansion-panel-header>
                                    <mat-panel-title
                                        style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                        <div style="display: flex; align-items: center;">
                                            <mat-icon class="me-2" style="color: #9c27b0;">shopping_cart</mat-icon>
                                            <span class="meal-title-text">Shopping Trip</span>
                                            <span *ngIf="trip.items && trip.items.length > 0"
                                                class="badge rounded-pill bg-secondary ms-2" style="font-size: 0.7em;">
                                                {{ trip.items.length }} items
                                            </span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <button mat-icon-button class="action-btn" color="primary"
                                                (click)="$event.stopPropagation(); editShoppingTrip(trip)"
                                                matTooltip="Edit Notes">
                                                <mat-icon style="font-size: 18px;">edit</mat-icon>
                                            </button>
                                            <button mat-icon-button class="action-btn" color="warn"
                                                (click)="$event.stopPropagation(); deleteShoppingTrip(trip)"
                                                matTooltip="Delete Trip">
                                                <mat-icon style="font-size: 18px;">close</mat-icon>
                                            </button>
                                        </div>
                                    </mat-panel-title>
                                </mat-expansion-panel-header>

                                <div class="trip-details">
                                    <p *ngIf="trip.notes" class="text-muted small mb-2" style="white-space: pre-wrap;">
                                        <strong>Notes:</strong> {{ trip.notes }}
                                    </p>

                                    <div *ngIf="trip.items && trip.items.length > 0; else noItems">
                                        <ul class="list-group list-group-flush small">
                                            <li class="list-group-item px-0 py-1" *ngFor="let item of trip.items"
                                                style="background: transparent;">
                                                <span>{{ item.quantity }} {{ item.unit }} {{ item.name }}</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <ng-template #noItems>
                                        <p class="text-muted small fst-italic mb-0">No specific items recommended yet.
                                        </p>
                                    </ng-template>
                                </div>
                            </mat-expansion-panel>
                        </div>
                    </div>
                    <!-- Empty drop zone helper so we can drop into empty days -->
                    <div *ngIf="!shoppingTrips[day.toDateString()]?.length" style="min-height: 10px;"></div>
                </div>

                <div class="add-meal-section">
                    <button mat-flat-button color="accent" [matMenuTriggerFor]="addMenu" class="w-100">
                        <mat-icon>add</mat-icon> Add Item
                    </button>
                    <mat-menu #addMenu="matMenu">
                        <button mat-menu-item (click)="openAddItemDialog(day, 'recipe')">
                            <mat-icon>restaurant_menu</mat-icon> Recipe
                        </button>
                        <button mat-menu-item (click)="openAddItemDialog(day, 'product')">
                            <mat-icon>kitchen</mat-icon> Product
                        </button>
                        <button mat-menu-item [matMenuTriggerFor]="leftoversMenu"
                            *ngIf="getLeftoverCandidates(day).length > 0">
                            <mat-icon>recycling</mat-icon> Leftovers
                        </button>
                        <mat-menu #leftoversMenu="matMenu">
                            <button mat-menu-item *ngFor="let plan of getLeftoverCandidates(day)"
                                (click)="addLeftover(day, plan)">
                                {{ plan.recipe?.title }} ({{ getRemainingServings(plan) }} left)
                            </button>
                        </mat-menu>
                        <mat-divider></mat-divider>
                        <button mat-menu-item (click)="addShoppingTrip(day)">
                            <mat-icon>shopping_cart</mat-icon> Shopping Trip
                        </button>
                    </mat-menu>
                </div>
            </div>
        </div>
    </div>
</div>